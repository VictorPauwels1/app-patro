// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  ADMIN
  ANIMATEUR_GARCONS
  ANIMATEUR_FILLES
}

enum PatroGroup {
  GARCONS
  FILLES
}

enum Section {
  // Garçons
  POUSSINS_G
  BENJAMINS
  CHEVALIERS
  CONQUERANTS
  BROTHERS
  
  // Filles
  POUSSINS_F
  BENJAMINES
  ETINCELLES
  ALPINES
  GRANDES
}

enum NewsletterType {
  POLICHINELLE  // Journal garçons
  GAZETTE       // Journal filles
}

// ============================================
// AUTHENTIFICATION
// ============================================

model User {
  id            String      @id @default(cuid())
  email         String      @unique
  password      String      // Hash bcrypt
  name          String
  role          Role        @default(ANIMATEUR_GARCONS)
  patroGroup    PatroGroup? // null pour ADMIN, obligatoire pour animateurs
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations
  eventsCreated Event[]
  albumsCreated Album[]
  messagesCreated Message[]
  newslettersCreated Newsletter[]
  campsCreated  Camp[]

  @@map("users")
}

// ============================================
// RESPONSABLES (PARENTS/TUTEURS)
// ============================================

model Parent {
  id            String   @id @default(cuid())
  firstName     String
  lastName      String
  relationship  String   // "Père", "Mère", "Autre: ..."
  email         String
  phone         String   @unique // Telephone normalise (identifiant unique)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  childrenAsPrimary   Child[] @relation("PrimaryParent")
  childrenAsSecondary Child[] @relation("SecondaryParent")
  
  @@map("parents")
}

// ============================================
// ENFANTS
// ============================================

model Child {
  id            String      @id @default(cuid())
  firstName     String
  lastName      String
  birthDate     DateTime
  patroGroup    PatroGroup  // GARCONS ou FILLES
  section       Section?    // Section assignée automatiquement
  
  // Adresse (commune aux 2 parents)
  address       String
  city          String
  postalCode    String
  
  // Email secondaire (facultatif)
  secondaryEmail String?
  
  // Relations avec les 2 responsables
  primaryParentId   String
  primaryParent     Parent  @relation("PrimaryParent", fields: [primaryParentId], references: [id], onDelete: Cascade)
  
  secondaryParentId String
  secondaryParent   Parent  @relation("SecondaryParent", fields: [secondaryParentId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations
  registrations Registration[]
  campRegistrations CampRegistration[]
  
  @@map("children")
}

// ============================================
// INSCRIPTIONS ANNUELLES
// ============================================

model Registration {
  id            String   @id @default(cuid())
  
  // Enfant concerné
  childId       String
  child         Child    @relation(fields: [childId], references: [id], onDelete: Cascade)
  
  // Année scolaire (ex: "2024-2025")
  year          String
  
  // Fiche médicale complète (JSON)
  medicalInfo   Json?    // Structure détaillée ci-dessous
  
  // Poids (pour certaines activités)
  weight        Float?
  
  // Droits à l'image
  photoConsent  String   // "full", "background", "none"
  photoUsage    Boolean  @default(false) // Utilisation dans communications
  photoArchive  Boolean  @default(false) // Utilisation pour archives
  
  // Autorisation médicale d'urgence
  emergencyMedicalConsent Boolean @default(false)
  
  // Remarques générales
  remarks       String?
  
  // Statut paiement
  isPaid        Boolean @default(false)
  amount        Float   @default(45) // Cotisation annuelle
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([childId, year])
  @@map("registrations")
}

// ============================================
// CAMPS
// ============================================

model Camp {
  id            String      @id @default(cuid())
  name          String
  description   String?
  startDate     DateTime
  endDate       DateTime
  price         Float
  patroGroup    PatroGroup? // null = commun, sinon GARCONS ou FILLES
  isPublic      Boolean     @default(true)
  
  // Lieu
  location      String?
  
  // Créateur
  createdById   String
  createdBy     User        @relation(fields: [createdById], references: [id])
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations
  registrations CampRegistration[]
  
  @@map("camps")
}

model CampRegistration {
  id            String   @id @default(cuid())
  
  // Camp
  campId        String
  camp          Camp     @relation(fields: [campId], references: [id], onDelete: Cascade)
  
  // Enfant
  childId       String
  child         Child    @relation(fields: [childId], references: [id], onDelete: Cascade)
  
  // Fiche médicale spécifique au camp (peut être différente de l'inscription annuelle)
  medicalInfo   Json?
  
  // Remarques spécifiques au camp
  remarks       String?
  
  // Paiement
  isPaid        Boolean  @default(false)
  paidAmount    Float?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([campId, childId]) // Un enfant ne peut s'inscrire qu'une fois par camp
  @@map("camp_registrations")
}

// ============================================
// CALENDRIER (ÉVÉNEMENTS)
// ============================================

model Event {
  id            String      @id @default(cuid())
  title         String
  description   String?
  startDate     DateTime
  endDate       DateTime?
  location      String?
  
  // Visibilité
  patroGroup    PatroGroup? // null = commun, GARCONS ou FILLES
  isPublic      Boolean     @default(true) // false = visible uniquement animateurs
  
  // Créateur
  createdById   String
  createdBy     User        @relation(fields: [createdById], references: [id])
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@map("events")
}

// ============================================
// ALBUMS PHOTOS
// ============================================

model Album {
  id            String      @id @default(cuid())
  name          String
  description   String?
  
  // Visibilité
  patroGroup    PatroGroup? // null = commun
  isPrivate     Boolean     @default(false) // true = visible uniquement animateurs
  
  // Créateur
  createdById   String
  createdBy     User        @relation(fields: [createdById], references: [id])
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations
  photos        Photo[]
  
  @@map("albums")
}

model Photo {
  id            String   @id @default(cuid())
  url           String   // URL de stockage (local ou cloud)
  caption       String?
  
  // Album
  albumId       String
  album         Album    @relation(fields: [albumId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  
  @@map("photos")
}

// ============================================
// MESSAGES AUX PARENTS
// ============================================

model Message {
  id            String      @id @default(cuid())
  title         String
  content       String      // Texte du message
  
  // Destinataires
  patroGroup    PatroGroup? // null = message commun, GARCONS ou FILLES
  isPublic      Boolean     @default(true)
  
  // Auteur
  createdById   String
  createdBy     User        @relation(fields: [createdById], references: [id])
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@map("messages")
}

// ============================================
// JOURNAUX (POLICHINELLE & GAZETTE)
// ============================================

model Newsletter {
  id            String         @id @default(cuid())
  title         String
  type          NewsletterType // POLICHINELLE ou GAZETTE
  year          String         // Ex: "2024-2025"
  edition       Int            // Numéro d'édition (1, 2, 3...)
  pdfUrl        String         // URL du PDF
  isPublic      Boolean        @default(true)
  
  // Créateur
  createdById   String
  createdBy     User           @relation(fields: [createdById], references: [id])
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@unique([type, year, edition]) // Pas de doublon
  @@map("newsletters")
}